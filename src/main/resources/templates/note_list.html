<!DOCTYPE html>
<html data-theme="light" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <link rel="stylesheet" href="/test.css"/>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.3/dist/full.css" rel="stylesheet" type="text/css"/>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css"
    />
    <link
            rel="stylesheet"
            href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css"
    />
    <!--    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.3/dist/full.css" rel="stylesheet" type="text/css"/>-->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="text-center">
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- 하이라이트 라이브러리, 언어 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/php-template.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/sql.min.js"></script>
<!-- 토스트 UI 에디터, 신택스 하이라이트 플러그인 추가 -->
<script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>
<form id="updateForm" th:action="@{|/note/${noteDetail.id}/page/update|}" method="post" onsubmit="return false">
    <div class="header bg-gray-800">
        <h1 class="text-white text-[2rem] p-[20px]">CNote</h1>
    </div>
    <div class="main h-[750px] overflow-hidden flex">
        <div class="left-side-menu min-w-[10%] bg-red-300 text-white overflow-hidden">
            <div class="left-side-menu-content h-[80%] w-[100%] px-[5px] overflow-y-scroll">
                <h1 class="text-[1rem] p-[20px] border-b-[1px] font-bold">노트 목록</h1>
                <ul class="menu bg-red-300 w-56">
                    <li th:replace="fragments/note_fragment::note_tree(${noteDetail}, ${noteList})"></li>
                </ul>
            </div>
            <div>
                <a class="block bg-gray-100 p-[10px] text-black border-[2px] border-gray-300 hover:bg-gray-800 hover:text-white"
                   th:href="@{/note/add}">+ 노트 추가</a>
            </div>
        </div>
        <div class="left-second-menu-content w-[10%] bg-blue-300">
            <h1 class="text-[1.5rem] p-[20px] border-b-[1px] font-bold">페이지 목록</h1>
            <ul th:each="notePage : ${notePageList}">
                <li th:with="customClass=${notePage.id == pageDetail.id} ? 'bg-green-200 border-b-[3px] border-red-400' : 'border-b-[1px]'"
                    th:class="|${customClass}|">
                    <a class="block p-[10px] w-[100%]" th:href="@{|/note/${noteDetail.id}/page/${notePage.id}|}"
                       th:text="${notePage.title}" th:id="|article_${notePage.id}|" onclick="setScroll('left-second-menu-content');"></a>
                </li>
            </ul>
        </div>
        <div class="content w-[80%] overflow-x-hidden overflow-y-hidden">
            <div class="flex justify-between">
                <input class="block border-b-[1px] font-bold p-[10px] mb-[10px] focus:outline-none" type="text"
                       name="title"
                       th:value="${pageDetail.title}">
                <div class="mr-[20px] mt-[15px]"><a href="#" class="font-bold text-red-500"
                                                    onclick="confirmDelete()">X</a></div>
            </div>
            <div class="toast-editor-container">
                <div id="editor" class="text-red text-left"></div>
            </div>
        </div>
    </div>
    <div>
        <input type="hidden" name="pageId" th:value="${pageDetail.id}">
        <input type="hidden" name="content">
    </div>
</form>
<form th:action="@{/note/${noteDetail.id}/page/delete}" id="delete" method="post"></form>
<!--<div class="foot text-center text-white bg-gray-800 h-[50px]">-->
<!--    <h1>footer</h1>-->
<!--</div>-->
<script th:inline="javascript">

    const Editor = toastui.Editor;
    const editor = new Editor({
        el: document.querySelector("#editor"),
        plugins: [toastui.Editor.plugin.codeSyntaxHighlight],
        height: "730px",
        initialEditType: "markdown",
        previewStyle: "vertical",
        hideModeSwitch: true,
        initialValue: [[${pageDetail.notePageDetail.content}]]
    });

    const wysiwygIframe = document.querySelector('.md-mode .ProseMirror');
    wysiwygIframe.setAttribute('spellcheck', 'false');
    document.addEventListener('keydown', handleKeyDown, {capture: true});

    titleInput = document.querySelector("input[name='title']");
    titleInput.setAttribute('spellcheck', 'false');
    titleInput.addEventListener('keydown', function (e) {
        if (e.keyCode === 13) {
            e.preventDefault();
            editor.focus();
        }
    });

    editor.on('change', () => {
        document.querySelectorAll(".toast-editor-container a").forEach((item) => {
            item.setAttribute('target', '_blank');
        });
    });

    // 페이지 목록 저장된 스크롤 값을 불러오기
    // const leftSideMenu = document.querySelector('.left-side-menu-content');
    // const savedPosition = localStorage.getItem('scrollPosition');
    // console.log(savedPosition);
    // if (!(savedPosition === 'undefined' || savedPosition == null)) {
    //     leftSideMenu.scrollTop = savedPosition;
    // }

    // 노트 트리에서 열려있는 노트 재현
    if(localStorage.getItem('openList') !== null) {
        reproduce();
    }

    initScrollPosition('left-side-menu-content');
    initScrollPosition('left-second-menu-content');

    // front에서 스크롤 조정. 너무 번거로움. 그냥 서버에 scroll값 넘겨서 처리하자.
    // let leftSideMenu = document.querySelector('.left-side-menu-content');
    // leftSideMenu.scrollTop = 0;
    // let itemHeight = 70;
    // console.log(leftSideMenu.clientHeight);
    // console.log(itemHeight);
    // console.log(leftSideMenu.clientHeight / itemHeight);
    //
    // scrollMoveThresh = Math.floor(leftSideMenu.clientHeight / itemHeight);
    // scrollMoveValue = itemHeight * (articleId - scrollMoveThresh);
    // console.log(articleId);
    // console.log(scrollMoveValue);
    // leftSideMenu.scrollTop = scrollMoveValue;
    function confirmDelete() {
        if (confirm('정말 삭제하시겠습니까?')) {
            let input = document.querySelector('#updateForm [name="noteId"]');
            let deleteForm = document.querySelector('#delete');
            deleteForm.appendChild(input);
            deleteForm.submit();
        }
    }

    function initScrollPosition(className) {
        const element = document.querySelector('.' + className);
        const savedPosition = localStorage.getItem(className + '_scrollPosition');
        if (!(savedPosition === 'undefined' || savedPosition == null)) {
            element.scrollTop = savedPosition;
        }
    }

    function setScroll(className) {
        let element = document.querySelector('.' + className);
        localStorage.setItem(className + '_scrollPosition', element.scrollTop);
    }

    // function setScroll() {
    //     console.log('test');
    //     let leftSideMenu = document.querySelector('.left-side-menu-content');
    //     console.log(leftSideMenu.scrollTop);
    //     localStorage.setItem('scrollPosition', leftSideMenu.scrollTop);
    // }

    function handleKeyDown(event) {
        // Ctrl + K 단축키를 감지
        if (event.ctrlKey && event.key.toLowerCase() === 's') {
            event.preventDefault();
            form = document.querySelector('#updateForm');
            form.content.value = editor.getMarkdown();
            form.submit();
            event.stopPropagation();  // 이벤트 전파 중지
            // 원하는 동작을 실행
        } else if (event.ctrlKey && event.key.toLowerCase() === 'r') {
            event.preventDefault();
            if (editor.isWysiwygMode()) {
                editor.changeMode('markdown');
                document.querySelector('input[name="title"]').readOnly = false;
                editor.blur();
            } else {
                editor.changeMode('wysiwyg');
                document.querySelector('.ww-mode .toastui-editor-contents').setAttribute('contenteditable', 'false');
                document.querySelector('input[name="title"]').readOnly = true;
            }
            event.stopPropagation();  // 이벤트 전파 중지
        }
    }
    function noteEventHandle(className) {
        setCollapse();
        setScroll(className);
    }
    function setCollapse() {
        let tagList = document.querySelectorAll("details");
        let openList = [];
        for (let i = 0; i < tagList.length; i++) {
            result = tagList[i].getAttribute('open');
            if(result !== null) {
                openList.push(tagList[i].id);
            }
        }
        localStorage.setItem('openList', JSON.stringify(openList));
    }

    function reproduce() {
        let openList = JSON.parse(localStorage.getItem('openList'));
        for (let i = 0; i < openList.length; i++) {
            let tag = document.querySelector('#' + openList[i]);
            tag.setAttribute('open', '');
        }
    }

</script>
</body>
</html>