<!DOCTYPE html>
<html data-theme="light" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.2/dist/full.min.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/global.css"/>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css"
    />
    <link
            rel="stylesheet"
            href="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight.min.css"
    />
    <!--    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.3/dist/full.css" rel="stylesheet" type="text/css"/>-->
</head>
<body>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- ÌïòÏù¥ÎùºÏù¥Ìä∏ ÎùºÏù¥Î∏åÎü¨Î¶¨, Ïñ∏Ïñ¥ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/php.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/php-template.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/sql.min.js"></script>
<!-- ÌÜ†Ïä§Ìä∏ UI ÏóêÎîîÌÑ∞, Ïã†ÌÉùÏä§ ÌïòÏù¥ÎùºÏù¥Ìä∏ ÌîåÎü¨Í∑∏Ïù∏ Ï∂îÍ∞Ä -->
<script src="https://uicdn.toast.com/editor-plugin-code-syntax-highlight/latest/toastui-editor-plugin-code-syntax-highlight-all.min.js"></script>
<!--<form id="updateForm" th:action="@{|/note/${noteDetail.id}/page/update|}" method="post" onsubmit="return false">-->
<!--    <div class="header bg-gray-800">-->
<!--        <h1 class="text-white text-[2rem] p-[20px]">CNote</h1>-->
<!--        <div>-->
<!--        </div>-->
<!--    </div>-->
<div class="navbar bg-gray-800 text-white py-[20px] border-b-[3px] border-white">
    <div class="flex-1">
        <a class="btn btn-ghost normal-case text-[30px]">CNote</a>
    </div>
    <div class="flex justify-end">
        <img class="h-[5%] w-[5%] mr-[10px] rounded-[50%]" src="/img/2023071701753_0.jpg" alt="profile">
        <div class="text-[13px]"><a class="hover:cursor-pointer" onclick="test();">profile</a></div>
        <div class="text-white"></div>

        <a class="text-[13px] hover:bg-gray-600 p-[5px] rounded-md" sec:authorize="isAnonymous()" href="/user/login">login</a>
        <a class="text-[13px] hover:bg-gray-600 p-[5px] rounded-md" sec:authorize="isAuthenticated()"
           href="/user/logout">logout</a>

        <ul class="menu menu-horizontal px-1">
            <li>
                <label class="swap swap-rotate hover:text-white hover:bg-gray-600 p-[5px]">
                    <input type="checkbox" id="nav-toggle"/>
                    <svg class="swap-off fill-current" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                         viewBox="0 0 512 512">
                        <path d="M64,384H448V341.33H64Zm0-106.67H448V234.67H64ZM64,128v42.67H448V128Z"/>
                    </svg>
                    <svg class="swap-on fill-current" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                         viewBox="0 0 512 512">
                        <polygon
                                points="400 145.49 366.51 112 256 222.51 145.49 112 112 145.49 222.51 256 112 366.51 145.49 400 256 289.49 366.51 400 400 366.51 289.49 256 400 145.49"/>
                    </svg>
                </label>
            </li>
        </ul>
    </div>
</div>
<div class="main overflow-hidden flex relative">
    <div id="profile-modal">

    </div>
    <div class="left-side-wrap h-[calc(100vh-95px)] flex relative">
        <div id="left-note-container" class="flex w-[100%]">
            <form id="noteUIForm">
                <input type="hidden" name="noteUIParamJson" id="noteUIParamJson">
                <input type="hidden" th:id="csrf-header" th:value="${_csrf.headerName}"/>
                <input type="hidden" th:id="csrf-token" th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}"/>
                <ul id="note-list-area" class="menu bg-gray-800">
                    <!--                            <li th:replace="~{fragments/note_fragment::note_tree(${noteDetail}, ${noteList})}"></li>-->
                </ul>
            </form>
<!--            <div th:class="'left-side-menu bg-gray-800 text-white overflow-hidden'"-->
<!--                 th:classappend="${noteUIParam} ? ${'w-[' + noteUIParam.noteWidth + 'px]'} : 'w-[400px]'">-->
<!--                <div class="flex h-[10%] items-center justify-around border-r-[1px] border-b-[1px] font-bold">-->
<!--                    <h1 class="text-[1rem] p-[20px] ">ÎÖ∏Ìä∏ Î™©Î°ù ..</h1>-->
<!--                </div>-->
<!--                <div class="left-side-menu-content custom-scroll h-[83%] px-[5px] overflow-y-scroll">-->
<!--                </div>-->
<!--                <div class="left-side-menu-content-async custom-scroll h-[83%] px-[5px] overflow-y-scroll">-->

<!--                </div>-->
                <script src="/async_note.js"></script>
                <div id="async">

                </div>

                <div class="flex items-center text-center justify-center border border-gray-300 ">
                    <form th:action="@{/note/add}" method="post">
                        <input type="submit" value="Ï∂îÍ∞Ä">
                    </form>
                    <dialog id="my_modal_1" class="modal text-black">
                        <div class="modal-box">
                            <h3 class="font-bold text-lg">ÎÖ∏Ìä∏ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω</h3>
                            <div>
                                <form th:action method="post">
                                    <div class="my-[10px]">
                                        <input type="text" class="input input-bordered w-full max-w-xs"
                                               name="noteName">
                                    </div>
                                    <div>
                                        <button class="btn">Ok</button>
                                    </div>
                                </form>
                                <form method="dialog">
                                    <button class="btn">Close</button>
                                </form>
                            </div>
                        </div>
                    </dialog>
                </div>
            </div>
            <div class="side-control-bar w-[5px] h-[100%] bg-gray-800 hover:cursor-move"></div>
            <div class="custom-scroll left-second-menu-content bg-gray-800 text-white overflow-scroll"
                 th:classappend="${noteUIParam} ? ${'w-[' + noteUIParam.pageWidth + 'px]'} : 'w-[400px]'">
                <h1 class="text-[1rem] p-[20px] font-bold">ÌéòÏù¥ÏßÄ Î™©Î°ù</h1>
                <ul th:each="notePage : ${notePageList}">
                    <li th:with="customClass=${notePage.id == pageDetail.id} ? 'bg-gray-500 border-b-[3px]' : 'border-b-[1px]'"
                        th:class="|${customClass}|">
                        <!--                           th:href="@{|/note/${noteDetail.id}/page/${notePage.id}|}"-->
                        <div class="flex border-b-[1px] items-center">
                            <span>üìÑ</span>
                            <a class="block p-[10px] text-[15px] hover:cursor-pointer"
                               th:text="${notePage.title}" th:id="|article_${notePage.id}|"
                               th:attr="note-id=${notePage.note.id}, page-id=${notePage.id}"
                               th:href="@{|/note/${notePage.note.id}/page/${notePage.id}|}"
                               onclick="submitWithOpenList(this); return false;"></a>
                        </div>
                    </li>
                </ul>
                <div class="absolute top-[90%]">
                    <form th:action="@{|/note/${noteDetail.id}/page/${pageDetail.id}|}"
                          class="flex relative justify-between items-center">
                        <input type="text" placeholder="Search" name="keyword"
                               class="input input-bordered text-black w-full max-w-xs"
                               id="search-input" autocomplete="off">
                        <input type="submit" class="btn text-white hover:text-black" value="search">
                        <div class="searchBox hidden absolute z-10 bottom-[100%] left-[0] bg-gray-600 bg-opacity-[98%] h-[50vh] w-[100%] p-[20px]">
                            <div class="content border h-[100%] border-white overflow-scroll">
                                <ul class="m-[10px]" th:if="${searchedResult}">
                                    <li th:each="note : ${searchedResult.searchedNoteList}"
                                        class="hover:bg-gray-400 px-[0.5rem]"><a
                                            th:href="@{|/note/${note.id}?keyword=${searchedResult.keyword}|}"
                                            class="inline-block w-[100%]" th:text="${note.name}"
                                            th:classappend="${note.id == noteDetail.id} ? 'bg-gray-400' : ''"></a></li>
                                    <li th:unless="${#lists.isEmpty(searchedResult.searchedNotePageList)}"
                                        th:each="notePage : ${searchedResult.searchedNotePageList}"
                                        class="hover:bg-gray-400 px-[0.5rem]">
                                        <!--                                            th:href="@{|/note/${notePage.note.id}/page/${notePage.id}?keyword=${searchedResult.keyword}|}"-->

                                        <a
                                                class="inline-block w-[100%]"
                                                th:classappend="${notePage.id == noteDetail.id} ? 'bg-gray-400':'' "
                                                th:text="${notePage.title}"></a></li>
                                </ul>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="side-control-bar w-[5px] h-[100%] bg-gray-800 hover:cursor-move"></div>
        </div>
    </div>
    <div class="content h-[100vh-94px] w-[100%] overflow-x-hidden overflow-y-hidden">
        <form id="updateForm" th:action="@{|/note/${noteDetail.id}/page/update|}" method="post" onsubmit="return false">
            <div class="flex justify-between">

                <input class="block border-b-[1px] font-bold p-[10px] mb-[10px] focus:outline-none" type="text"
                       name="title"
                       th:value="${pageDetail.title}">
                <a href="#" class="font-bold text-red-500 p-[10px]"
                   onclick="confirmDelete()">X</a>
            </div>
            <div>
                <input type="hidden" name="pageId" th:value="${pageDetail.id}">
                <input type="hidden" name="content">
            </div>
        </form>
        <div th:replace="~{fragments/toast_editor::test}">
        </div>
    </div>
</div>
<form th:action="@{/note/${noteDetail.id}/page/delete}" id="delete" method="post"></form>
<script src="/note_list_ui.js"></script>
<script th:inline="javascript">

    let noteUIParam = [[${noteUIParam}]];
    if (noteUIParam != null) {
        initScrollPosition(noteUIParam.noteSideScrollPosition, noteUIParam.pageSideScrollPosition);
    }

    sideControlBars = document.querySelectorAll(".side-control-bar");
    let isDragging = false;
    let onDragTarget = null;
    sideControlBars.forEach(function (item) {
        item.addEventListener("mousedown", function (e) {
            isDragging = true;
            onDragTarget = e.target;
            console.log(onDragTarget);
        });
    });

    document.querySelector(".main").addEventListener("mousemove", function (e) {
        if (isDragging) {
            let target = onDragTarget.previousElementSibling;
            let standard = e.pageX + onDragTarget.clientWidth / 2;
            if (standard >= e.clientX) {
                target.style.transform = "scaleX(0.99)";
            } else {
                target.style.transform = "scaleX(1.01)";
            }

            target.style.width = e.clientX - target.getBoundingClientRect().x + "px";
            target.style.transform = "scaleX(1)";
        }
    });

    document.querySelector("body").addEventListener("mouseup", function (e) {
        if (isDragging) {
            // document.querySelector(".main").style.cursor = 'default';
            isDragging = false;
        }
    });
    let body = document.querySelector("body");
    let searchBox = document.querySelector(".searchBox");
    let searchInput = document.querySelector("#search-input");

    searchInput.addEventListener('focusin', function (e) {
        searchBox.style.display = 'block';
    });

    if (searchInput.value !== '') {
        searchBox.style.display = 'block';
    }

    searchInput.addEventListener('focusout', function (e) {
        searchBox.style.display = 'none';
    });

    body.addEventListener('click', function (e) {
        if (e.target.id !== 'search-input') {
            searchBox.style.display = 'none';
        }
        if (e.target.id !== 'note-menu-popup' && document.querySelector("#note-menu-popup") !== null) {
            body.removeChild(document.querySelector("#note-menu-popup"));
        }
    });

    function test() {
        let html = `
        <div class="w-[500px] h-[600px] bg-blue-500 absolute top-[50%] left-[50%] translate-x-[-50%] translate-y-[-50%] z-[999] flex flex-col justify-around items-center">
            <div class="w-[50%] h-[40%]">
                <img class="bg-gray-300 rounded-[50%]" src="/img/2023071701753_0.jpg" alt="profile-img">
            </div>
            <div>
                <form th:action="@{/member/profile}" method="post" enctype="multipart/form-data">
                    <input type="file" class="btn">
                </form>
            </div>
            <div>
                <input class="btn" type="button" value="Îã´Í∏∞" onclick="document.querySelector('#profile-modal').innerHTML = '';">
            </div>
        </div>
        `
        document.querySelector("#profile-modal").innerHTML = html;

    }

    function close() {
        document.querySelector("#profile-modal").innerHTML = '';
    }

    function createNoteListContent() {
        return document.createElement(`
            <div class="left-side-menu bg-gray-800 text-white overflow-hidden">
            </div>
        `);
    }

    function createNoteListItems() {
        return document.createElement(`
            <div class="flex h-[10%] items-center justify-around border-r-[1px] border-b-[1px] font-bold">
                <h1 class="text-[1rem] p-[20px] ">ÎÖ∏Ìä∏ Î™©Î°ù ..</h1>
            </div>
            <div class="left-side-menu-content custom-scroll h-[83%] px-[5px] overflow-y-scroll">
                <ul id="note-list-area" class="menu bg-gray-800">

                </ul>
            </div>
        `);
    }
    function renderingNoteTree(data) {

        console.log(data);
        const noteListContainer = document.querySelector("#left-note-container");
        const noteListContent = createNoteListContent();
        const noteListItems = createNoteListItems();

        const html = `
            ${createNoteTree(data.noteList)}
        `;

        noteListItems.innerHTML = html;
        noteListContent.appendChild(noteListItems);
        noteListContainer.appendChild(noteListContent);

        console.log(noteListContainer);

    }

    function createNoteTree(noteList) {
        return `
            ${noteList.map((note) => {
            return `${createNoteItem(note)}`;
        }).join('')}
        `
    }

    function createChildNoteTree(note, noteItemClass, recurFunc) {
        return `
            <details>
                <summary class="${noteItemClass}"><a>${note.name}</a></summary>
                <ul>
                    ${note.children.length > 0 ? recurFunc(note.children) : ''}
                </ul>
            </details>
        `
    }

    function createNoteItem(note) {

        let noteItemClass = "hover:bg-gray-500 hover:text-white hover:rounded-md";
        let groupItemClass = note.groupYn === 0 ? noteItemClass : "";

        return `
            <li class="${groupItemClass}">
                ${note.groupYn === 0 ? `<a onclick="getNotes();">${note.name}</a>` : ``}
                ${note.groupYn === 1 ? createChildNoteTree(note, noteItemClass, createNoteTree) : ''}
            </li>
        `
    }

    function getNotes() {
        const headerName = document.querySelector("#csrf-header").value;
        const token = document.querySelector("#csrf-token").value;
        const noteUIParamJson = getNoteUIParamJsonStr();

        fetch("/api/notes", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [headerName]: token
            },
            body: noteUIParamJson
        })
            .then(response => response.json())
            .then(data => {
                renderingNoteTree(data);
            })
            .catch(error => {
                console.error('Error:', error);
            });

    }

    getNotes();

</script>

</body>
</html>